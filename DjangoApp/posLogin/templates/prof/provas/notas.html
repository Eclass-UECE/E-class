<!DOCTYPE html>
{% load static %}
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas</title>
    <link rel="stylesheet" href="{% static 'css/notas.css' %}">
    <link rel="stylesheet" href="https://fonts.cdnfonts.com/css/extenda-trial">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto&display=swap">
</head>
<body>

    <!-- Header -->
    <header class="header">
        <a href="{% url 'pagInicial' %}">
            <img src="{% static 'img/eclass_logo3.png' %}" alt="Eclass">
        </a>

        <div class="nav-icon">
            <a href="{% url 'pagProf' %}">
                <img src="{% static 'img/home_icon_alt.png' %}" alt="Home">
            </a>
            <a href="{% url 'diario' %}">
                <img src="{% static 'img/diario_icon_alt.png' %}" alt="Diário">
            </a>
        </div>
    </header>

    <section>
        <div>
            <h1>Lançar Notas</h1>
            <h3>Período Letivo: {{turma.semestre_atual}} </h3> <!---Informa o período letivo do historico de aulas-->
            <h3>Turma: S{{turma.semestre_letivo}} T{{turma.numero_turma}} {{turma.turno}} </h3> <!--Informa o semestre e a turma a qual pertece o historico de aulas-->
            <h3>Etapa: </h3> <!--Informa a etapa da prova - Mid ou Final - -->
            <label for="dataProva"><strong>Data da Prova:</strong></label>
            <input type="date" id="dataProva" name="dataProva">
        </div>

        <p class="alert">AS NOTAS DEVEM SER INSERIDAS DE 0 A 100, SEM CASAS DECIMAIS</p>

        <table>
            <thead>
                <tr>
                    <th>MATRÍCULA</th>
                    <th>NOME</th>
                    <th>NOTA</th>
                    <th>OBSERVAÇÕES</th>
                </tr>
            </thead>
            <tbody>
                    {% for aluno in alunos_turma %}
                    <tr id="linha-{{ aluno.matricula }}">
                        <td class="matricula"> {{ aluno.matricula }}</td>
                        <td class="nome">{{ aluno.nome_completo }}</td>
                        <td>
                            <input 
                            type="number" 
                            class="nota"
                            name="nota_{{ aluno.matricula }}
                            min="0" max="100" step="1"></td>
                        <td>
                            <input 
                            type="text"
                            class="observação"
                            name="observação_{{ aluno.matricula }}"
                            size="30"></td>

                            </tr>

                        {% endfor %}       
                    
            </tbody>
        </table>
        <td>  <button type="button" onclick="salvarNota({{aluno.matricula}})">Salvar</button>

    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-bottom">
        © 2024 E-Class | Todos os direitos reservados
        </div>
    </footer>

</body>

    <script>

        //Limita a nota para 100
        document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('input[type=number]').forEach(input => {
            input.addEventListener('input', () => {
            let val = input.value;
            if (val === '') return;
            val = parseInt(val);
            if (isNaN(val)) {
                input.value = '';
                return;
            }
            if (val > 100) input.value = 100;
            else if (val < 0) input.value = 0;
            });
        });
        });

    </script>

<script>

function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

function salvarNota(matricula) {

    obsInput = ".objetivos input";
    obsClass= ".objetivos";
    obsCampo = "objetivos";

    notaInput = ".nota input";
    notaClass= ".nota";
    notaCampo = "nota";

    const dados = [];
    document.querySelectorAll('tbody tr').forEach(linha => {
        const matricula = linha.querySelector('.matricula').textContent.trim();
        const nota = linha.querySelector('.nota').value;
        const observacao = linha.querySelector('.observação').value;

        dados.push({
            matricula: matricula,
            nota: nota,
            observacao: observacao
        });
    });

    console.log(dados); // Enviar para o backend com fetch() ou AJAX

  fetch("/pagProf/aulas/notas/", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "X-CSRFToken": getCookie("csrftoken"), 
  },
  body: JSON.stringify({
    dados: dados,
  }),
})
  .then(response => {
    if (!response.ok) {
      throw new Error("Erro ao salvar");
    }
    return response.json();
  })
  .then(data => {
    console.log("Salvo com sucesso!", data);
  })
  .catch(error => {
    alert("Erro ao salvar no banco.");
    console.error(error);
  });
  
  }
  
  
  </script>


</html>
